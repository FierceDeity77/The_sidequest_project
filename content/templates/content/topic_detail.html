{% extends "base.html" %}
{% load static %}
{% load comments_tags %}
{% load widget_tweaks %}

{% block page_title %} Topic Detail {% endblock %}

{% block content %}
<div class="card shadow-sm p-3 mb-3">
  <div class="d-flex">
    
    <!-- Post Content -->
    <div class="flex-grow-1">
      <div class="d-flex align-items-center mb-2">
        <img src="{{ topic.author.avatar.url }}" alt="avatar" 
             class="rounded-circle me-2" width="32" height="32">
        <a href="{% url 'user-profile' topic.author.id %}" class="author-name-link small text-muted me-2">
          {{ topic.author.username }}
        </a>
        <span class="text-muted small me-2">{{ topic.created_at|timesince }} ago</span>

        <!-- Edit/Delete only visible to author -->
        {% if request.user == topic.author or request.user.is_staff %}
          <div class="dropdown ms-auto">
            <button class="btn btn-link btn-sm text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm">
              <li>
                <button type="button" 
                        class="dropdown-item text-primary"
                        data-bs-toggle="modal" 
                        data-bs-target="#editTopicModal">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </li>
              <li>
                <form method="post" action="{% url 'content:delete-topic' topic.slug %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item text-danger">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </form>
              </li>
            </ul>
          </div>
        {% endif %}
      </div>

      <h5 class="mb-2">{{ topic.title }}</h5>
      <p>{{ topic.text }}</p>

      <!-- Vote Section -->
      <div class="d-flex align-items-center gap-2 me-3">
        {% include "content/includes/topic_vote_buttons.html" %}
      </div>

      <!-- Comments Section -->
      <div class="mt-3 border-top pt-3">
        <h6 class="fw-bold mb-3">Comments</h6>

        <!-- Comment Form -->
        <form method="post" action="{% url 'content:add-comment' topic.slug %}" class="mb-3 comment-form" id="comment-form">
          {% csrf_token %}
          <div class="d-flex align-items-start">
            {% if request.user.is_authenticated and request.user.avatar %}
              <img src="{{ request.user.avatar.url }}"
                  alt="avatar"
                  class="rounded-circle me-2"
                  width="32" height="32"
                  onerror="this.onerror=null;this.src='{% static 'default_images/default-avatar.jpg' %}';">
            {% else %}
              <img src="{% static 'default_images/default-avatar.jpg' %}"
                  alt="avatar"
                  class="rounded-circle me-2"
                  width="32" height="32">
            {% endif %}

            <div class="flex-grow-1">
              {{ comment_form.text|add_class:"form-control border rounded-3 p-2" }}
              <div class="d-flex justify-content-end mt-2">
                <button type="submit" class="btn btn-submit-comment btn-sm">Comment</button>
              </div>
            </div>
          </div>
        </form>

        <!-- Comment List  -->
         <div id="comments-section">  
        {% for comment in comment_list %}
            <div class="comment-item">
            {% render_comment comment topic %}
            </div>
        {% endfor %}
         </div>
        
         {% if comment_list|length > 3 %} {% comment %} .count will work only on a query set in this case it is already evaluated in the view so length filter is used {% endcomment %}
         <button class="show-more-comments btn btn-sm btn-link mt-2 ">
            more comments
         </button>
         {% endif %}

      </div>
    </div>
  </div>
</div>
<!-- Include Edit Topic Modal -->
{% include "content/edit_topic_modal.html" %}

<!-- Include Edit Community Modal -->
{% include "content/edit_community_modal.html" %}

<!-- Include Create Sub-Community Modal -->
{% include "content/add_sub-community_modal.html" %}

{% endblock %}

{% block left_panel %}
  {% include "includes/left_sidepanel.html" %}
{% endblock %}

{% block right_panel %}
  {% include "includes/sidepanel.html" %}
{% endblock %}

