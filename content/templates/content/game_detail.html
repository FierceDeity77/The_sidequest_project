{% extends "base.html" %}
{% load static %}

{% block page_title %}{{ game.title }} | The Sidequest{% endblock %}

{% block content %}
<div class="game-detail my-4">

  <!-- Game Header -->
  <div class="row mb-4">
    <!-- Game Cover -->
    <div class="col-md-4 text-center">
      {% if game.cover_image %}
        <img src="{{ game.cover_image.url }}" alt="{{ game.title }}" class="img-fluid rounded border shadow-sm">
      {% else %}
        <div class="bg-light border rounded d-flex align-items-center justify-content-center"
             style="width: 100%; height: 250px;">
          <span class="text-muted">No Cover</span>
        </div>
      {% endif %}
    </div>

    <!-- Game Info -->
    <div class="col-md-8">
      <h1 class="fw-bold mb-2">{{ game.title }}</h1>

      <!-- Platforms -->
      <p class="mb-1 small">
        <strong>Platforms:</strong>
        {% for platform in game.platforms.all %}
          <span class="badge bg-secondary">{{ platform.name }}</span>
        {% empty %}
          <span class="text-muted">No platforms listed</span>
        {% endfor %}
      </p>

      <!-- Release Date -->
      {% if game.release_date %}
        <p class="mb-1 small"><strong>Release Date:</strong> {{ game.release_date }}</p>
      {% endif %}

      <!-- Average Rating -->
      <p class="mb-2 small">
        <strong>Average Rating:</strong>
        {{ game.average_rating|default:"N/A" }}
      </p>

      <!-- Description -->
      <p class="text-muted small">{{ game.description }}</p>
    </div>
  </div>

  <!-- Tabs Section -->
  <ul class="nav nav-tabs" id="gameTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="feed-tab" data-bs-toggle="tab" href="#feed" role="tab">Feed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="community-tab" data-bs-toggle="tab" href="#community" role="tab">Community</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="guides-tab" data-bs-toggle="tab" href="#guides" role="tab">Guides</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="reviews-tab" data-bs-toggle="tab" href="#reviews" role="tab">Reviews</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="news-tab" data-bs-toggle="tab" href="#news" role="tab">News</a>
    </li>
  </ul>

  <div class="tab-content border border-top-0 p-3 rounded-bottom bg-white shadow-sm" id="gameTabsContent">
    <!-- Feed -->
    <div class="tab-pane fade show active" id="feed" role="tabpanel">
      <p class="text-muted small">Latest activity and updates related to {{ game.title }}.</p>
    </div>

    <!-- Community -->
    <div class="tab-pane fade" id="community" role="tabpanel">
      {% if game.communities.all %}
        <!-- Main Communities -->
        <h6 class="fw-bold text-uppercase small text-muted mb-2">Main Communities</h6>
        <ul class="list-group list-group-flush mb-3">
          {% for community in game.communities.all %}
            {% if not community.parent %}
              <li class="list-group-item">
                <div class="d-flex align-items-center mb-1">
                  {% if community.icon %}
                    <img src="{{ community.icon.url }}" alt="{{ community.name }}"
                         class="rounded-circle me-2" width="40" height="40">
                  {% else %}
                    <div class="rounded-circle bg-secondary me-2"
                         style="width:40px; height:40px;"></div>
                  {% endif %}

                  <div>
                    <a href="{% url 'content:community-detail' community.slug %}" class="fw-bold small link-dark text-decoration-none hover-underline">
                      {{ community.name }}
                    </a>
                    <div class="text-muted small">
                      üë§ Creator: {{ community.created_by.username }} ¬∑ 
                      üë• Members: {{ community.members.count }}
                    </div>
                  </div>
                </div>
              </li>
            {% endif %}
          {% empty %}
            <li class="list-group-item text-muted small">No main communities yet.</li>
          {% endfor %}
        </ul>

        <!-- Sub-Communities -->
        <h6 class="fw-bold text-uppercase small text-muted mb-2">Sub-Communities</h6>
        <ul class="list-group list-group-flush">
          {% for community in game.communities.all %}
            {% if community.parent %}
              <li class="list-group-item">
                <div class="d-flex align-items-center mb-1">
                  {% if community.icon %}
                    <img src="{{ community.icon.url }}" alt="{{ community.name }}"
                         class="rounded-circle me-2" width="32" height="32">
                  {% else %}
                    <div class="rounded-circle bg-secondary me-2"
                         style="width:32px; height:32px;"></div>
                  {% endif %}

                  <div>
                    <a href="{% url 'content:community-detail' community.slug %}" class="small link-dark text-decoration-none hover-underline">
                      {{ community.name }}
                    </a>
                    <div class="text-muted small">
                      üë§ Creator: {{ community.created_by.username }} ¬∑ 
                      üë• Members: {{ community.members.count }}
                    </div>
                  </div>
                </div>
              </li>
            {% endif %}
          {% empty %}
            <li class="list-group-item text-muted small">No sub-communities yet.</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted small">No communities linked to this game yet.</p>
      {% endif %}
    </div>

    <!-- Guides -->
    <div class="tab-pane fade" id="guides" role="tabpanel">
      <p class="text-muted small">Guides for {{ game.title }}.</p>
    </div>

    <!-- Reviews -->
    <div class="tab-pane fade" id="reviews" role="tabpanel">
      <p class="text-muted small">User reviews will appear here.</p>
    </div>

    <!-- News -->
    <div class="tab-pane fade" id="news" role="tabpanel">
      <p class="text-muted small">Latest news and announcements about {{ game.title }}.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block right_panel %}
  <!-- Game Actions -->
  <div class="card mb-3">
    <div class="card-body text-center">

      <!-- Rating Section -->
      <div class="mb-3">
        <div class="d-flex justify-content-center align-items-center {{ game.rating_color }}">
          <span class="fw-bold text-warning fs-5 me-1">‚≠ê</span>
          <span class="fw-bold" style="font-size: 1.1rem;">
            {{ game.approval_percentage|default:"N/A" }}
          </span>
        </div>
        <small class="text-muted">Average Rating</small>
      </div>

      <!-- Upvote / Downvote -->
      <div class="d-flex justify-content-center align-items-center mb-3">
        {% include "content/includes/game_vote_buttons.html" %}
      </div>

      <!-- Followers count -->
      <div class="mb-2">
        <span class="fw-bold d-block fs-5" id="followers-{{ game.id }}">
          {{ game.member_count }}
        </span>
        <small class="text-muted">Followers</small>
      </div>

      <!-- Follow Button -->
      {% if request.user.is_authenticated %}
        <button class="btn btn-sm btn-outline-success follow-btn w-100"
                data-id="{{ game.id }}"
                data-model="game"
                data-action="follow"
                data-csrf="{{ csrf_token }}">
          {% if request.user in game.members.all %}
            Unfollow
          {% else %}
            Follow
          {% endif %}
        </button>
      {% endif %}
    </div>
  </div>

  <!-- Example: Trending Games -->
  <div class="card shadow-sm mb-3">
    <div class="card-header fw-bold small">Trending Games</div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item small">Elden Ring</li>
      <li class="list-group-item small">Resident Evil 4 Remake</li>
      <li class="list-group-item small">Final Fantasy XVI</li>
    </ul>
  </div>
{% endblock %}