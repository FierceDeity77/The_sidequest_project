{% load comments_tags %}
{% load static %}

<div id="comment-{{ comment.id }}" class="comment d-flex mb-2 ms-{{ comment.parent|yesno:'1,0' }}">
  <div class="comment-avatar">
    {% if comment.author and comment.author.avatar %}
      <img src="{{ comment.author.avatar.url }}" alt="avatar" 
           class="rounded-circle" width="28" height="28">
    {% else %}
      <img src="{% static 'default_images/default-avatar.jpg' %}" alt="avatar" 
           class="rounded-circle" width="28" height="28">
    {% endif %}
  </div>

  <div class="comment-body ms-2">
    <div class="d-flex align-items-center">
      <a href="{% url 'user-profile' comment.author.id %}" 
         class="comment-author-link fw-bold small text-muted me-2">
          {{ comment.author.username }}
      </a>
      <span class="text-muted small me-2">
        {{ comment.created_at|timesince }} ago
      </span>
    </div>

    <!-- Comment text (shown by default) -->
    <p class="mb-1 comment-text" id="comment-text-{{ comment.id }}">{{ comment.text }}</p>

    <!-- Inline edit form (hidden by default) -->
    <form method="post" 
          action="{% url 'content:edit-comment' comment.id %}" 
          class="edit-comment-form" 
          id="edit-form-{{ comment.id }}" 
          data-comment-id="{{ comment.id }}"
          style="display: none;">
      {% csrf_token %}
      <div class="d-flex flex-column gap-2">
        <textarea name="text" class="form-control form-control-sm" rows="2">{{ comment.text }}</textarea>
        <div class="d-flex gap-2 justify-content-end">
          <button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-comment-id="{{ comment.id }}">
            Cancel
          </button>
          <button type="submit" class="btn btn-sm btn-primary">Save</button>
        </div>
      </div>
    </form>

    <!-- Voting section -->
    <div class="d-flex align-items-center gap-2 mb-1">
      <button class="vote-btn {% if request.user in comment.upvotes.all %}upvote-active{% endif %}" 
        data-id="{{ comment.id }}" 
        data-type="post" 
        data-model="comments"
        data-action="upvote" 
        data-csrf="{{ csrf_token }}">
        ▲ <span id="upvotes-{{ comment.id }}">{{ comment.upvotes.count }}</span>
      </button>

      <button class="vote-btn {% if request.user in comment.downvotes.all %}downvote-active{% endif %}" 
              data-id="{{ comment.id }}" 
              data-type="post" 
              data-model="comments"
              data-action="downvote" 
              data-csrf="{{ csrf_token }}">
        ▼ <span id="downvotes-{{ comment.id }}">{{ comment.downvotes.count }}</span>
      </button>

      <!-- Reply button / form -->
      {% include "content/includes/reply_form.html" %}

      <div class="d-flex align-items-center gap-2">
      <span class="text-muted small">{{ comment.replies.count }} replies</span>
      
      <!-- Comment options dropdown -->
      {% include "content/includes/comment_options.html" %}

  </div>
    </div>
    <!-- Replies Section -->
    <!-- Recursive replies -->
    <div class="comment-replies ms-1 mt-2">
      {% for reply in comment.replies.all %}
        <div class="reply-item">
          {% render_comment reply topic %}
        </div>
      {% endfor %}
    </div>
    <!-- Show more replies button -->
      {% if comment.replies.count > 1 %}
      <button class="show-more-replies btn btn-link btn-sm p-0 mt-1">
        more replies
      </button>
    {% endif %}
  </div>
</div>